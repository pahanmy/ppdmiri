<!DOCTYPE html>
<html lang="ms" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTempahan - MyPPD Miri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .smooth-transition { transition: all 0.3s ease-in-out; }
        .sidebar-link.active { background-color: #eff6ff; color: #2563eb; font-weight: 600; }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        .step-indicator.active .step-circle { background-color: #2563eb; color: white; }
        .step-indicator.active .step-text { color: #2563eb; font-weight: 600; }
        .step-indicator .step-line { background-color: #e5e7eb; }
         .step-indicator.active .step-line { background-color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="relative min-h-screen md:flex">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-20 md:hidden hidden"></div>

        <aside id="sidebar" class="bg-white text-gray-800 w-64 space-y-6 py-7 px-4 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30 shadow-lg">
            <div class="px-2">
                <h1 class="text-2xl font-bold text-blue-700">MyPPD Miri</h1>
            </div>
            
            <nav id="sidebar-nav" class="flex flex-col space-y-2">
                <a href="index.html" data-target="dashboard" class="sidebar-link flex items-center space-x-3 py-2 px-3 rounded-lg text-gray-600 hover:bg-gray-100 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="mytempahan.html" data-target="mytempahan" class="sidebar-link active flex items-center space-x-3 py-2 px-3 rounded-lg text-gray-600 hover:bg-gray-100 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span class="font-medium">MyTempahan</span>
                </a>
                <a href="mykenderaan.html" data-target="mykenderaan" class="sidebar-link flex items-center space-x-3 py-2 px-3 rounded-lg text-gray-600 hover:bg-gray-100 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2-2h8a1 1 0 001-1z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"></path></svg>
                    <span class="font-medium">MyKenderaan</span>
                </a>
                <a href="myppd.html" data-target="myppd" class="sidebar-link flex items-center space-x-3 py-2 px-3 rounded-lg text-gray-600 hover:bg-gray-100 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                    <span class="font-medium">MyPPD</span>
                </a>
                <a href="#" data-target="myplanner" class="sidebar-link flex items-center space-x-3 py-2 px-3 rounded-lg text-gray-600 hover:bg-gray-100 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <span class="font-medium">MyPlanner</span>
                </a>
                <a href="#" data-target="myqr" class="sidebar-link flex items-center space-x-3 py-2 px-3 rounded-lg text-gray-600 hover:bg-gray-100 smooth-transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v.01M12 8v.01M12 12v.01M12 16v.01M8 4v.01M8 8v.01M8 12v.01M8 16v.01M4 4v.01M4 8v.01M4 12v.01M4 16v.01M16 4v.01M16 8v.01M16 12v.01M16 16v.01M20 4v.01M20 8v.01M20 12v.01M20 16v.01" />
                    </svg>
                    <span class="font-medium">MyQR</span>
                </a>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-sm md:hidden sticky top-0 z-10">
                <div class="px-6 py-4 flex justify-between items-center">
                    <h1 class="text-xl font-bold text-blue-700">MyPPD Miri</h1>
                    <button id="mobile-menu-button" class="text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </header>

            <main class="flex-1 p-6 md:p-10">
                <section id="mytempahan" class="content-section">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-md">
                        <div class="flex flex-col md:flex-row items-start md:items-center justify-between pb-6 border-b">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">MyTempahan Bilik Mesyuarat</h2>
                                <p class="text-gray-500">Pejabat Pendidikan Daerah Miri</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <button id="buka-modal-tempahan" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 smooth-transition flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    Tempah Bilik
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 my-6">
                            <div>
                                <label for="bilik-filter" class="block text-sm font-medium text-gray-600 mb-1">Pilih Bilik</label>
                                <select id="bilik-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                            </div>
                            <div>
                                <label for="bulan-filter" class="block text-sm font-medium text-gray-600 mb-1">Pilih Bulan</label>
                                <select id="bulan-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                            </div>
                            <div>
                                <label for="tarikh-filter" class="block text-sm font-medium text-gray-600 mb-1">Pilih Julat Tarikh</label>
                                <input type="text" id="tarikh-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer" readonly>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-blue-800">TEMPAHAN DITEMUI</p>
                                <p id="jumlah-tempahan" class="text-3xl font-bold text-blue-800">0</p>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Tarikh</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Nama Pegawai</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Tujuan</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Bilik</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Masa</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Status</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody id="jadual-tempahan" class="text-gray-600"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>

            <footer class="bg-white mt-auto border-t">
                <div class="container mx-auto px-6 py-8 text-center text-gray-500">
                    <p>&copy; 2024 Hak Cipta Terpelihara. Pejabat Pendidikan Daerah Miri.</p>
                </div>
            </footer>
        </div>
    </div>
    
    <div id="modal-tempahan" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Borang Permohonan Tempahan Bilik</h3>
                <button id="tutup-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 border-b">
                <div class="flex items-center">
                    <div id="step-indicator-1" class="step-indicator active flex-1 flex items-center"><div class="step-circle w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">1</div><p class="step-text ml-3 text-sm text-gray-500">Maklumat Pegawai</p></div>
                    <div class="step-line flex-1 h-0.5 bg-gray-200"></div>
                    <div id="step-indicator-2" class="step-indicator flex-1 flex items-center"><div class="step-circle w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">2</div><p class="step-text ml-3 text-sm text-gray-500">Butiran Tempahan</p></div>
                    <div class="step-line flex-1 h-0.5 bg-gray-200"></div>
                    <div id="step-indicator-3" class="step-indicator flex-1 flex items-center"><div class="step-circle w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">3</div><p class="step-text ml-3 text-sm text-gray-500">Pilihan Bilik</p></div>
                </div>
            </div>
            <form id="borang-tempahan">
                <div class="p-6">
                    <div id="mesej-borang" class="hidden p-4 mb-4 rounded-lg"></div>
                    
                    <div id="step-1" class="space-y-5">
                        <div class="p-4 mb-3 rounded-lg bg-blue-50 text-blue-800 border border-blue-200">
                            <h4 class="font-bold">Panduan Tempahan:</h4>
                            <ul class="list-disc list-inside text-sm mt-2">
                                <li>Sila masukkan No. Kad Pengenalan anda (12 digit tanpa sengkang).</li>
                                <li>Nama dan Sektor/Unit anda akan dipaparkan secara automatik jika No. KP anda wujud dalam pangkalan data.</li>
                                <li>Lengkapkan butiran tempahan dan pilih bilik yang tersedia.</li>
                            </ul>
                        </div>
                        <div class="relative"><label for="no-ic" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan <span class="text-red-500">*</span></label><input type="number" id="no-ic" placeholder="Cth: 850101131234 (tanpa sengkang)" class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none top-7"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 012-2h2a2 2 0 012 2v1m-4 0h4"></path></svg></div></div>
                        <div class="relative"><label for="nama-pegawai" class="block text-sm font-medium text-gray-700 mb-1">Nama Pegawai</LabeL><input type="text" id="nama-pegawai" class="w-full p-3 pl-10 bg-gray-100 border border-gray-300 rounded-lg" readonly><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none top-7"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div></div>
                        <div class="relative"><label for="sektor-unit" class="block text-sm font-medium text-gray-700 mb-1">Sektor / Unit</label><input type="text" id="sektor-unit" class="w-full p-3 pl-10 bg-gray-100 border border-gray-300 rounded-lg" readonly><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none top-7"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></div></div>
                    </div>
                    <div id="step-2" class="hidden space-y-5">
                        <div id="info-pegawai-step2" class="hidden mb-5 p-3 bg-gray-100 rounded-lg border"><p class="text-sm font-medium text-gray-700">Permohonan oleh: <span id="nama-pemohon-step2" class="font-bold"></span> (<span id="sektor-pemohon-step2"></span>)</p></div>
                        <div class="relative"><label for="tujuan" class="block text-sm font-medium text-gray-700 mb-1">Tujuan Tempahan <span class="text-red-500">*</span></label><input type="text" id="tujuan" class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none top-7"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg></div></div>
                        <div class="relative"><label for="jumlah-peserta" class="block text-sm font-medium text-gray-700 mb-1">Anggaran Jumlah Peserta <span class="text-red-500">*</span></label><input type="number" id="jumlah-peserta" class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none top-7"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="tarikh-mula" class="block text-sm font-medium text-gray-700 mb-1">Tarikh Mula <span class="text-red-500">*</span></label><input type="date" id="tarikh-mula" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                            <div><label for="lebih-sehari-checkbox" class="block text-sm font-medium text-gray-700 mb-1">&nbsp;</label><div class="flex items-center h-full"><input id="lebih-sehari-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lebih-sehari-checkbox" class="ml-2 block text-sm text-gray-900">Tempahan melebihi satu hari</label></div></div>
                        </div>
                        <div id="container-tarikh-tamat" class="hidden"><label for="tarikh-tamat" class="block text-sm font-medium text-gray-700 mb-1">Tarikh Tamat <span class="text-red-500">*</span></label><input type="date" id="tarikh-tamat" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Sesi Masa</label><div class="flex flex-wrap gap-2"><button type="button" data-start="08:00" data-end="12:00" class="time-preset-btn bg-blue-50 text-blue-700 text-sm font-medium py-2 px-3 rounded-lg hover:bg-blue-100">Pagi (8am-12pm)</button><button type="button" data-start="14:00" data-end="17:00" class="time-preset-btn bg-blue-50 text-blue-700 text-sm font-medium py-2 px-3 rounded-lg hover:bg-blue-100">Petang (2pm-5pm)</button><button type="button" data-start="08:00" data-end="17:00" class="time-preset-btn bg-blue-50 text-blue-700 text-sm font-medium py-2 px-3 rounded-lg hover:bg-blue-100">Sepenuh Hari (8am-5pm)</button></div></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="masa-mula" class="block text-sm font-medium text-gray-700 mb-1">Masa Mula <span class="text-red-500">*</span></label><input type="time" id="masa-mula" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                            <div><label for="masa-tamat" class="block text-sm font-medium text-gray-700 mb-1">Masa Tamat <span class="text-red-500">*</span></label><input type="time" id="masa-tamat" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                        </div>
                    </div>
                    <div id="step-3" class="hidden">
                        <div id="info-pegawai-step3" class="hidden mb-5 p-3 bg-gray-100 rounded-lg border"><p class="text-sm font-medium text-gray-700">Permohonan oleh: <span id="nama-pemohon-step3" class="font-bold"></span> (<span id="sektor-pemohon-step3"></span>)</p></div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bilik Untuk Ditempah <span class="text-red-500">*</span></label>
                        <div id="bilik-visual-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        <div id="bilik-nota-container" class="hidden mt-4 p-4 rounded-lg bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800"><h4 class="font-bold">Perhatian</h4><p id="bilik-nota-text" class="text-sm"></p></div>
                    </div>
                </div>
                <div class="p-6 border-t mt-6 flex justify-between items-center"><button type="button" id="btn-kembali" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 smooth-transition">Kembali</button><button type="button" id="btn-seterusnya" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 smooth-transition">Seterusnya</button><button type="submit" id="btn-hantar" class="hidden bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 smooth-transition">Hantar Permohonan</button></div>
            </form>
        </div>
    </div>
    
    <div id="modal-batal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-semibold text-gray-800">Sahkan Pembatalan</h3><button id="tutup-modal-batal" class="text-gray-400 hover:text-gray-600">&times;</button></div>
            <form id="borang-batal"><div class="p-6 space-y-4"><p class="text-sm text-gray-600">Untuk meneruskan pembatalan, sila masukkan semula nombor kad pengenalan anda untuk pengesahan.</p><div id="mesej-batal" class="hidden p-3 rounded-lg text-sm"></div><div><label for="ic-batal" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan</label><input type="number" id="ic-batal" placeholder="Masukkan No. KP anda" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required></div></div><div class="p-6 bg-gray-50 rounded-b-xl flex justify-end items-center gap-3"><button type="button" id="btn-tutup-batal" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 smooth-transition">Tutup</button><button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 smooth-transition">Sahkan Pembatalan</button></div></form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === DATA APLIKASI ===
            // Data Pegawai dan Tempahan kini diuruskan oleh Google Apps Script (Code.gs)
            
            // Data Bilik (statik) dikekalkan
            const bilikInfo = [
                { id: 'wisma-persekutuan', nama: 'Bilik Mesyuarat Wisma Persekutuan', kapasiti: 50, img: 'https://placehold.co/400x200/e2e8f0/64748b?text=Wisma+Persekutuan', tempahanSebulan: 18, nota: null },
                { id: 'sektor-perancangan', nama: 'Bilik Mesyuarat Sektor Perancangan', kapasiti: 30, img: 'https://placehold.co/400x200/dbeafe/3b82f6?text=Sektor+Perancangan', tempahanSebulan: 7, nota: 'Dilarang untuk program melibatkan pelajar sama ada rakaman atau sebarang aktiviti.' },
                { id: 'peperiksaan-1', nama: 'Bilik Peperiksaan 1', kapasiti: 60, img: 'https://placehold.co/400x200/fee2e2/dc2626?text=Peperiksaan+1', tempahanSebulan: 25, nota: 'Sila hubungi Pn Fauziah untuk tempahan di bilik ini. Keutamaan diberi kepada urusan peperiksaan.' },
                { id: 'peperiksaan-2', nama: 'Bilik Peperiksaan 2', kapasiti: 30, img: 'https://placehold.co/400x200/fef3c7/f59e0b?text=Peperiksaan+2', tempahanSebulan: 12, nota: 'Sila hubungi Pn Fauziah untuk tempahan di bilik ini. Keutamaan diberi kepada urusan peperiksaan.' },
                { id: 'mini-mesyuarat', nama: 'Bilik Mini Mesyuarat (Bilik Hijau)', kapasiti: 30, img: 'https://placehold.co/400x200/d1fae5/10b981?text=Bilik+Hijau', tempahanSebulan: 5, nota: 'Untuk tempahan bilik ini, sila klik pautan khas: <a href="http://tinyurl.com/DashboardTempahanCOEPPDMiri" target="_blank" class="text-blue-600 hover:underline font-semibold">Dashboard Tempahan Bilik Hijau</a>' }
            ];

            let tempahanDataCache = []; // Cache untuk simpan data dari Google Sheet
            let tempahanUntukBatalId = null;

            // === PENGURUSAN DOM ===
            const sidebar = document.getElementById('sidebar');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            // Modal Tempahan Bilik
            const modalTempahan = document.getElementById('modal-tempahan');
            const bukaModalBtn = document.getElementById('buka-modal-tempahan');
            const tutupModalBtn = document.getElementById('tutup-modal');
            const borangTempahan = document.getElementById('borang-tempahan');
            const mesejBorang = document.getElementById('mesej-borang');
            
            // Modal Batal Tempahan
            const modalBatal = document.getElementById('modal-batal');
            const tutupModalBatalBtn = document.getElementById('tutup-modal-batal');
            const btnTutupBatal = document.getElementById('btn-tutup-batal');
            const borangBatal = document.getElementById('borang-batal');
            const inputIcBatal = document.getElementById('ic-batal');
            const mesejBatalEl = document.getElementById('mesej-batal');

            // Jadual Tempahan & Penapis
            const jadualTempahanBody = document.getElementById('jadual-tempahan');
            const jumlahTempahanEl = document.getElementById('jumlah-tempahan');
            const bilikFilterSelect = document.getElementById('bilik-filter');
            const bulanFilterSelect = document.getElementById('bulan-filter');
            const tarikhFilterInput = document.getElementById('tarikh-filter');
            const bilikVisualContainer = document.getElementById('bilik-visual-container');
            const bilikNotaContainer = document.getElementById('bilik-nota-container');
            const bilikNotaText = document.getElementById('bilik-nota-text');
            
            // Borang Fields Tempahan
            const inputIC = document.getElementById('no-ic');
            const inputNama = document.getElementById('nama-pegawai');
            const inputSektor = document.getElementById('sektor-unit');
            const inputTujuan = document.getElementById('tujuan');
            const inputJumlahPeserta = document.getElementById('jumlah-peserta');
            const inputTarikhMula = document.getElementById('tarikh-mula');
            const inputMasaMula = document.getElementById('masa-mula');
            const inputMasaTamat = document.getElementById('masa-tamat');
            const lebihSehariCheckbox = document.getElementById('lebih-sehari-checkbox');
            const containerTarikhTamat = document.getElementById('container-tarikh-tamat');
            const inputTarikhTamat = document.getElementById('tarikh-tamat');
            const infoPegawaiStep2 = document.getElementById('info-pegawai-step2');
            const namaPemohonStep2 = document.getElementById('nama-pemohon-step2');
            const sektorPemohonStep2 = document.getElementById('sektor-pemohon-step2');
            const infoPegawaiStep3 = document.getElementById('info-pegawai-step3');
            const namaPemohonStep3 = document.getElementById('nama-pemohon-step3');
            const sektorPemohonStep3 = document.getElementById('sektor-pemohon-step3');

            // Wizard/Step Elements
            let currentStep = 1;
            const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
            const stepIndicators = [document.getElementById('step-indicator-1'), document.getElementById('step-indicator-2'), document.getElementById('step-indicator-3')];
            const btnKembali = document.getElementById('btn-kembali');
            const btnSeterusnya = document.getElementById('btn-seterusnya');
            const btnHantar = document.getElementById('btn-hantar');
            const timePresetBtns = document.querySelectorAll('.time-preset-btn');
            
            // === FUNGSI-FUNGSI ===

            /**
             * [FUNGSI BARU] Memuat turun data tempahan dari Google Sheet
             */
            function muatSemulaDataTempahan() {
                jadualTempahanBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Memuatkan data tempahan...</td></tr>`;
                jumlahTempahanEl.textContent = '...';
                
                google.script.run
                    .withSuccessHandler(data => {
                        tempahanDataCache = data; // Simpan data dalam cache
                        applyFiltersAndRenderTempahan(); // Paparkan data berdasarkan penapis
                    })
                    .withFailureHandler(err => {
                        jadualTempahanBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-red-500">Gagal memuatkan data tempahan. Sila muat semula.</td></tr>`;
                        jumlahTempahanEl.textContent = 'E';
                    })
                    .getSenaraiTempahan();
            }
            
            function paparPilihanBilik() {
                bilikVisualContainer.innerHTML = '';
                bilikFilterSelect.innerHTML = '<option value="">Semua Bilik</option>';
                bilikInfo.forEach(bilik => {
                    const visualOption = `
                        <div>
                            <input type="radio" name="pilih-bilik-radio" id="${bilik.id}" value="${bilik.nama}" class="hidden peer" required>
                            <label for="${bilik.id}" class="block p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 peer-checked:border-blue-600 peer-checked:ring-1 peer-checked:ring-blue-500">
                                <div class="relative">
                                    <img src="${bilik.img}" alt="${bilik.nama}" class="w-full h-24 object-cover rounded-md mb-2">
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs font-semibold px-2 py-1 rounded-full flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-orange-300" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a5.5 5.5 0 00-5.5 5.5c0 2.624 1.343 4.88 3.328 6.257a.75.75 0 001.085-.929C8.32 13.56 8 12.58 8 11.5a2.5 2.5 0 115 0c0 1.08-.32 2.06-.913 2.885a.75.75 0 001.085.93 7 7 0 003.328-6.258A5.5 5.5 0 0010 3.5z" /></svg>
                                        <span>${bilik.tempahanSebulan}</span>
                                    </div>
                                </div>
                                <span class="font-medium text-gray-800 text-sm">${bilik.nama}</span>
                                <p class="text-xs text-gray-500">Kapasiti: ${bilik.kapasiti} orang</p>
                            </label>
                        </div>
                    `;
                    bilikVisualContainer.innerHTML += visualOption;
                    const filterOption = `<option value="${bilik.nama}">${bilik.nama}</option>`;
                    bilikFilterSelect.innerHTML += filterOption;
                });
            }

            function populateBulanFilter(selectElement) {
                const now = new Date();
                const months = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
                selectElement.innerHTML = '<option value="">Pilih Bulan</option>';

                for (let i = -6; i <= 6; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const monthName = months[month];
                    const value = `${year}-${String(month + 1).padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = `${monthName} ${year}`;
                    if (i === 0) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                }
            }
            
            // --- FUNGSI UNTUK TEMPAHAN BILIK ---
            function applyFiltersAndRenderTempahan() {
                const bilikDipilih = bilikFilterSelect.value;
                const startDate = pickerTempahan.getStartDate() ? pickerTempahan.getStartDate().dateInstance : null;
                const endDate = pickerTempahan.getEndDate() ? pickerTempahan.getEndDate().dateInstance : null;

                if(startDate) startDate.setHours(0, 0, 0, 0);
                if(endDate) endDate.setHours(23, 59, 59, 999);

                // [DIUBAHSUAI] Guna 'tempahanDataCache'
                const filteredData = (tempahanDataCache || []).filter(tempahan => {
                    const tempahanDate = new Date(tempahan.tarikh);
                    tempahanDate.setHours(12, 0, 0, 0); // Set to noon to avoid timezone issues

                    const bilikMatch = !bilikDipilih || tempahan.bilik === bilikDipilih;
                    const dateMatch = (!startDate || !endDate) || (tempahanDate >= startDate && tempahanDate <= endDate);

                    return bilikMatch && dateMatch;
                });
                
                paparJadualTempahan(filteredData);
            }

            function paparJadualTempahan(data) {
                jadualTempahanBody.innerHTML = '';
                // [DIUBAHSUAI] Guna .slice() untuk elak ubah data asal (cache)
                const sortedData = data.slice().sort((a, b) => new Date(b.tarikh) - new Date(a.tarikh));
                
                if (sortedData.length === 0) {
                    jadualTempahanBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Tiada tempahan ditemui untuk kriteria ini.</td></tr>`;
                } else {
                    sortedData.forEach(item => {
                        let statusClass, rowClass = '';
                        if (item.status === 'LULUS') { statusClass = 'bg-green-100 text-green-700'; } 
                        else if (item.status === 'DIBATALKAN') { statusClass = 'bg-gray-200 text-gray-600'; rowClass = 'text-gray-400 italic'; }

                        const formatTarikh = new Date(item.tarikh).toLocaleDateString('ms-MY', { day: 'numeric', month: 'short', year: 'numeric' });
                        
                        // [DIUBAHSUAI] Tambah data-ic untuk pengesahan pembatalan
                        const butangBatal = item.status === 'LULUS' 
                            ? `<button class="batal-btn text-red-600 hover:text-red-800 p-1 rounded-md hover:bg-red-50 flex items-center gap-1" data-id="${item.id}" data-ic="${item.ic}" data-type="tempahan">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                <span class="text-xs font-medium">Batal</span>
                              </button>` : '-';
                        
                        const row = `<tr class="border-b hover:bg-gray-50 ${rowClass}"><td class="py-3 px-4">${formatTarikh}</td><td class="py-3 px-4">${item.pegawai}</td><td class="py-3 px-4 text-sm">${item.tujuan}</td><td class="py-3 px-4 text-sm">${item.bilik}</td><td class="py-3 px-4 text-sm">${item.masaMula} - ${item.masaTamat}</td><td class="py-3 px-4"><span class="${statusClass} text-xs font-semibold px-2.5 py-1 rounded-full">${item.status}</span></td><td class="py-3 px-4">${butangBatal}</td></tr>`;
                        jadualTempahanBody.innerHTML += row;
                    });
                }
                jumlahTempahanEl.textContent = sortedData.length;
            }
            
            // --- FUNGSI UMUM ---
            function openSidebar() { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); }
            function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); }
            
            function resetBorang() {
                borangTempahan.reset(); inputNama.value = ''; inputSektor.value = '';
                mesejBorang.classList.add('hidden'); bilikNotaContainer.classList.add('hidden');
                containerTarikhTamat.classList.add('hidden'); infoPegawaiStep2.classList.add('hidden');
                infoPegawaiStep3.classList.add('hidden'); setTodayDate(); goToStep(1);
            }

            function openModal(modal) { 
                if (modal.id === 'modal-tempahan') { resetBorang(); }
                modal.classList.remove('hidden'); 
            }
            function closeModal(modal) { modal.classList.add('hidden'); }

            function openModalBatal(id, icPemohon, type) {
                tempahanUntukBatalId = { id, ic: icPemohon, type }; // Simpan ID dan IC
                borangBatal.reset();
                mesejBatalEl.classList.add('hidden');
                modalBatal.classList.remove('hidden');
            }
            function closeModalBatal() { modalBatal.classList.add('hidden'); }

            // [DIUBAHSUAI] Terima 'dataArray' sebagai parameter
            function checkKonflik(tempahanBaru, dataArray) {
                if (!dataArray) return false;
                return dataArray.some(sediaAda =>
                    sediaAda.bilik === tempahanBaru.bilik && sediaAda.tarikh === tempahanBaru.tarikh &&
                    sediaAda.status === 'LULUS' &&
                    tempahanBaru.masaMula < sediaAda.masaTamat && tempahanBaru.masaTamat > sediaAda.masaMula
                );
            }
            
            function paparkanMesej(el, jenis, teks) {
                el.innerHTML = teks; // Guna innerHTML untuk benarkan pautan
                el.className = `p-3 rounded-lg text-sm ${jenis === 'ralat' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
                el.classList.remove('hidden');
            }
            
            function setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                inputTarikhMula.value = today; inputTarikhMula.min = today; inputTarikhTamat.min = today;
            }

            function updateInfoPegawai() {
                const nama = inputNama.value; const sektor = inputSektor.value;
                if (nama && sektor) {
                    namaPemohonStep2.textContent = nama; sektorPemohonStep2.textContent = sektor; infoPegawaiStep2.classList.remove('hidden');
                    namaPemohonStep3.textContent = nama; sektorPemohonStep3.textContent = sektor; infoPegawaiStep3.classList.remove('hidden');
                } else {
                    infoPegawaiStep2.classList.add('hidden'); infoPegawaiStep3.classList.add('hidden');
                }
            }

            function goToStep(stepNumber) {
                if (stepNumber > 1) { updateInfoPegawai(); }
                currentStep = stepNumber;
                steps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== currentStep));
                stepIndicators.forEach((indicator, index) => indicator.classList.toggle('active', index < currentStep));
                btnKembali.classList.toggle('hidden', currentStep === 1);
                btnSeterusnya.classList.toggle('hidden', currentStep === 3);
                btnHantar.classList.toggle('hidden', currentStep !== 3);
            }
            
            function validateStep(stepNumber, formType) {
                const stepElement = steps[stepNumber - 1];
                const mesejElement = mesejBorang;
                if (!stepElement) return false;

                const inputs = stepElement.querySelectorAll('[required]');
                for (const input of inputs) {
                     if (!input.closest('.hidden') && !input.value.trim()) { 
                        let labelText = '';
                        const label = input.closest('div').querySelector('label');
                        if (label) {
                            labelText = label.textContent.replace('*', '').trim();
                        } else {
                            labelText = "Medan"; // Fallback
                        }
                        paparkanMesej(mesejElement, 'ralat', `Sila isi medan "${labelText}".`);
                        input.focus();
                        return false;
                    }
                }
                
                if (stepNumber === 1 && !inputNama.value) {
                    paparkanMesej(mesejBorang, 'ralat', 'No Kad Pengenalan tidak ditemui. Sila pastikan ia betul.');
                    inputIC.focus();
                    return false;
                }
                
                mesejElement.classList.add('hidden');
                return true;
            }

            // === EVENT LISTENERS ===
            
            mobileMenuButton.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
            sidebarOverlay.addEventListener('click', closeSidebar);
            
            // Listeners Tempahan
            bukaModalBtn.addEventListener('click', () => openModal(modalTempahan));
            tutupModalBtn.addEventListener('click', () => closeModal(modalTempahan));
            modalTempahan.addEventListener('click', (e) => { if (e.target === modalTempahan) closeModal(modalTempahan); });
            
            // Listeners Batal (Umum)
            tutupModalBatalBtn.addEventListener('click', closeModalBatal);
            btnTutupBatal.addEventListener('click', closeModalBatal);
            modalBatal.addEventListener('click', (e) => { if (e.target === modalBatal) closeModalBatal(); });
            
            /**
             * [DIUBAHSUAI] Guna google.script.run untuk cari pegawai
             */
            inputIC.addEventListener('blur', () => {
                const ic = inputIC.value;
                if (ic && (ic.length === 12 || ic.length === 6)) { // Benarkan KP 6 digit (polis/tentera)
                    // Tunjukkan 'loading'
                    inputNama.value = 'Mencari...';
                    inputSektor.value = 'Mencari...';
                    mesejBorang.classList.add('hidden');
                    
                    google.script.run
                        .withSuccessHandler(pegawai => {
                            if (pegawai && !pegawai.error) {
                                inputNama.value = pegawai.nama;
                                inputSektor.value = pegawai.sektor;
                                mesejBorang.classList.add('hidden');
                            } else {
                                inputNama.value = '';
                                inputSektor.value = '';
                                paparkanMesej(mesejBorang, 'ralat', 'No Kad Pengenalan tidak ditemui dalam Pangkalan Data Pegawai.');
                            }
                        })
                        .withFailureHandler(err => {
                            inputNama.value = '';
                            inputSektor.value = '';
                            paparkanMesej(mesejBorang, 'ralat', 'Ralat menyambung ke pangkalan data.');
                        })
                        .getPegawaiByIC(ic);
                } else if (ic) {
                    paparkanMesej(mesejBorang, 'ralat', 'Sila masukkan No. Kad Pengenalan yang sah.');
                } else {
                    inputNama.value = '';
                    inputSektor.value = '';
                }
            });

            lebihSehariCheckbox.addEventListener('change', () => {
                containerTarikhTamat.classList.toggle('hidden', !lebihSehariCheckbox.checked);
                inputTarikhTamat.required = lebihSehariCheckbox.checked;
            });

            timePresetBtns.forEach(btn => btn.addEventListener('click', () => {
                inputMasaMula.value = btn.dataset.start; inputMasaTamat.value = btn.dataset.end;
            }));
            
            // Wizard Navigation
            btnSeterusnya.addEventListener('click', () => { if (validateStep(currentStep, 'tempahan')) { goToStep(currentStep + 1); }});
            btnKembali.addEventListener('click', () => { goToStep(currentStep - 1); });
            
            bilikVisualContainer.addEventListener('change', (e) => {
                if (e.target.name === 'pilih-bilik-radio') {
                    const roomInfo = bilikInfo.find(b => b.nama === e.target.value);
                    if (roomInfo && roomInfo.nota) {
                        bilikNotaText.innerHTML = roomInfo.nota; bilikNotaContainer.classList.remove('hidden');
                    } else { bilikNotaContainer.classList.add('hidden'); }
                }
            });

            jadualTempahanBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.batal-btn');
                if (btn) {
                    const id = btn.dataset.id;
                    const icPemohon = btn.dataset.ic; // [DIUBAHSUAI] Ambil IC pemohon
                    const type = btn.dataset.type;
                    if (type === 'tempahan') {
                        openModalBatal(id, icPemohon, type);
                    }
                }
            });

            /**
             * [DIUBAHSUAI] Guna google.script.run untuk batal tempahan
             */
            borangBatal.addEventListener('submit', (e) => {
                e.preventDefault();
                const { id, ic, type } = tempahanUntukBatalId; // Ambil IC pemohon dari data
                if (type !== 'tempahan') return;
                
                const icPengesahan = inputIcBatal.value;
                
                // Pengesahan 1: Pastikan IC yang ditaip = IC pemohon
                if (icPengesahan !== ic) {
                    paparkanMesej(mesejBatalEl, 'ralat', 'No. Kad Pengenalan pengesahan tidak sepadan dengan No. KP pemohon asal.');
                    return;
                }

                // Pengesahan 2: Hantar ke server untuk batal
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            // Tukar status dalam cache secara manual (lebih pantas)
                            const itemInCache = tempahanDataCache.find(t => t.id == id);
                            if (itemInCache) {
                                itemInCache.status = 'DIBATALKAN';
                            }
                            applyFiltersAndRenderTempahan(); // Papar semula jadual
                            closeModalBatal();
                        } else {
                            paparkanMesej(mesejBatalEl, 'ralat', result.message || 'Pembatalan gagal.');
                        }
                    })
                    .withFailureHandler(err => {
                        paparkanMesej(mesejBatalEl, 'ralat', `RALAT: ${err.message}`);
                    })
                    .batalTempahan(id, icPengesahan); // Hantar ID tempahan dan IC pengesahan
            });

            /**
             * [DIUBAHSUAI] Guna google.script.run untuk hantar tempahan
             */
            borangTempahan.addEventListener('submit', (e) => {
                e.preventDefault(); if (!validateStep(3, 'tempahan')) return;
                const bilikRadio = document.querySelector('input[name="pilih-bilik-radio"]:checked');
                const bilikDipilih = bilikInfo.find(b => b.nama === bilikRadio.value);
                if (parseInt(inputJumlahPeserta.value, 10) > bilikDipilih.kapasiti) { paparkanMesej(mesejBorang, 'ralat', `RALAT: Jumlah peserta (${inputJumlahPeserta.value}) melebihi kapasiti bilik (${bilikDipilih.kapasiti} orang).`); return; }
                
                const tarikhMulaStr = inputTarikhMula.value;
                const tarikhTamatStr = lebihSehariCheckbox.checked ? inputTarikhTamat.value : tarikhMulaStr;
                if (lebihSehariCheckbox.checked && new Date(tarikhTamatStr) < new Date(tarikhMulaStr)) { paparkanMesej(mesejBorang, 'ralat', 'RALAT: Tarikh tamat tidak boleh sebelum tarikh mula.'); return; }
                
                let konflikDikesan = false;
                const senaraiTempahanHarian = []; // Kumpul semua tempahan (untuk kes berbilang hari)

                for (let d = new Date(tarikhMulaStr); d <= new Date(tarikhTamatStr); d.setDate(d.getDate() + 1)) {
                    const tempahanHarian = { 
                        ic: inputIC.value, 
                        tarikh: new Date(d).toISOString().split('T')[0], 
                        pegawai: inputNama.value, 
                        tujuan: inputTujuan.value, 
                        bilik: bilikDipilih.nama, 
                        masaMula: inputMasaMula.value, 
                        masaTamat: inputMasaTamat.value, 
                    };
                    
                    // [DIUBAHSUAI] Periksa konflik guna data dari 'tempahanDataCache'
                    if (checkKonflik(tempahanHarian, tempahanDataCache)) { 
                        konflikDikesan = true; 
                        paparkanMesej(mesejBorang, 'ralat', `GAGAL: Konflik jadual dikesan pada ${new Date(d).toLocaleDateString('ms-MY')}! Bilik ini telah ditempah pada masa tersebut.`); 
                        break; 
                    }
                    senaraiTempahanHarian.push(tempahanHarian); // Kumpul tempahan
                }
                
                if (!konflikDikesan) {
                    // Lumpuhkan butang hantar
                    btnHantar.disabled = true;
                    btnHantar.textContent = 'Menghantar...';
                    mesejBorang.classList.add('hidden');

                    // Hantar setiap tempahan ke Google Apps Script
                    let janjiSimpan = senaraiTempahanHarian.map(tempahan => {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve) // resolve dengan 'result'
                                .withFailureHandler(reject)
                                .simpanTempahan(tempahan);
                        });
                    });

                    // Tunggu semua selesai
                    Promise.all(janjiSimpan)
                        .then(results => {
                            // Semua berjaya
                            const resultPertama = results[0];
                            paparkanMesej(mesejBorang, 'berjaya', resultPertama.message);
                            
                            // Tambah data baru ke cache secara manual (lebih pantas)
                            results.forEach(res => {
                                if (res.success && res.newData) {
                                    tempahanDataCache.push(res.newData);
                                }
                            });
                            
                            applyFiltersAndRenderTempahan(); // Papar semula jadual
                            setTimeout(() => closeModal(modalTempahan), 2000);
                        })
                        .catch(err => {
                            // Jika salah satu gagal
                            paparkanMesej(mesejBorang, 'ralat', `RALAT: ${err.message || 'Satu tempahan gagal disimpan.'}`);
                        })
                        .finally(() => {
                            // Aktifkan semula butang
                            btnHantar.disabled = false;
                            btnHantar.textContent = 'Hantar Permohonan';
                        });
                }
            });
            
            // === INISIALISASI ===
            const pickerTempahan = new Litepicker({
                element: tarikhFilterInput, singleMode: false, format: 'DD MMM YYYY', lang: 'ms-MY',
                setup: (picker) => { 
                    picker.on('selected', (d1, d2) => { 
                        bulanFilterSelect.value = ''; // Kosongkan filter bulan
                        applyFiltersAndRenderTempahan(); 
                    }); 
                }
            });

            bulanFilterSelect.addEventListener('change', () => {
                const selectedMonth = bulanFilterSelect.value;
                if (selectedMonth) { 
                    const [year, month] = selectedMonth.split('-').map(Number); 
                    const startDate = new Date(year, month - 1, 1); 
                    const endDate = new Date(year, month, 0); 
                    pickerTempahan.setDateRange(startDate, endDate);
                    // setDateRange akan trigger 'selected' event, jadi tak perlu panggil applyFilters...()
                } else {
                    // Jika pengguna pilih "Pilih Bulan" (kosong)
                    pickerTempahan.clearSelection();
                    applyFiltersAndRenderTempahan(); // Papar semula tanpa penapis tarikh
                }
            });
            
            bilikFilterSelect.addEventListener('change', applyFiltersAndRenderTempahan);
            
            paparPilihanBilik();
            populateBulanFilter(bulanFilterSelect);
            setTodayDate();
            
            // Tetapkan julat tarikh awal (bulan semasa)
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            pickerTempahan.setDateRange(startOfMonth, endOfMonth);
            
            // PENTING: Litepicker.setDateRange() TIDAK akan trigger 'selected' event secara automatik.
            // Kita perlu panggil muatSemulaDataTempahan() secara manual untuk muat turun data
            // dan memaparkan jadual untuk kali pertama.
            muatSemulaDataTempahan(); 
        });
    </script>
</body>
</html>
